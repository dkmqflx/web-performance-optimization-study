## 1장. **블로그 사이트 최적화**

### 1.1 실습 내용 소개

- 실적으로 배우는 웹 성능 최적화 for React

- 실습내용

  - 이미지 사이즈 최적화

    - 이미지 사이즈가 너무 크면 서비스가 무거워지고
    - 이미지 사이즈가 너무 작으면 사용자가 저화질의 이미지를 보게 되서 불편함을 느낄 수 있다
    - 어떤 사이즈 이미지가 적절한지 배운다

  - Code Split

    - 코드를 분할 하는 것
    - 어떻게 해야 코드를 분할할 수 있는지
    - 언제 코드를 분할해야 하는지

  - 텍스트 압축

    - 어떤 페이지에 접속하게 되면 다양한 리소스를 다운 받게 된다
    - JS, CSS, HTML 등
    - 이런 리소스들을 다운 받기 전에, 미리 서버에서 압축해서 다운 받게 된다
    - 그러면 작은 사이즈로 서버에서 리소스를 다운 받을 수 있게 된다
    - 그렇게 웹 페이지는 빠르게 로드가 될 수 있다.
    - 이렇게 다운로드 받는 데이터 양을 줄여서 로딩 성능을 최적화 하는 것이다

  - → 위의 세가지는 로딩 성능 최적화
  - → 이렇게 세가지가 다운로드하는 데이터 양을 줄여서 로딩 성능을 최적화 하는 방법

  - Bottlenet 코드 최적화
    - 내가 어떤 서비스를 개발했는데 특정 자바스크립트 코드 때문에 서비스가 너무 느리게 로드 되고 실행이 되는 경우,
    - 그럴 때 어떤 코드가 무엇 때문인지 몰라서 해메게 되는 경우가 있는데
    - 그런 병목 현상을 일으키는 코드를 어떻게 찾아내고 어떻게 최적화 하는지를 배운다
    - → 아래는 렌더링 성능 최적화

  ***

  ### 1.2 분석 툴 소개 & 코드 다운로드

  - 크롬 Network 탭

    - 네트워크 리소스들의 상세한 정보를 알려준다

  - 크롬 Performance 탭

    - 웹 페이지가 동작할 때 실행되는 모든 작업들을 스크린샷, 그래프로 보여준다

  - 크롬 Audit 탭 (Light house)

    - 우리 서비스가 성능적으로 어느정도 수준인지를 알 수 있다
    - 점수를 매겨주고 그에대한 가이드라인도 알려준다

  - webpack-bundle-analyzer
    - 웹팩 라이브러리
    - 웹팩을 통해 번들링된 파일들이 어떤 코드를 갖고 있는지를 한눈에 보여주는 툴이다.

---

### 1.4 Audits 툴을 이용한 페이지 감사

- Audits(Light House)
  - 웹앱의 품질 개선을 위해 성능을 검사해주고 그 성능 향상을 위한 가이드를 제공해주는 도구
- Performance
  - 페이지의 성능을 나타내는 점수
- **OPPORTUNITIES, DIAGNOSTICS**
  - 웹 페이지의 문제점과 문제점을 해결하기 위한 가이드를 제시해준다.
  - **OPPORTUNITIES**
    - 리소스의 관점에서 가이드를 제공해준다
    - 즉, 로딩 성능 최적화와 연관이 있다
  - **DIAGNOSTICS**
    - 페이지의 실행 관점에서 가이드를 제공해준다
    - 즉, 렌더링 성능 최적화와 연관이 있다
    - 회색항목은 문제가 되는 것은 아니지만 한번 살펴볼 필요는 있다는 것
- **PASSED AUDITS**
  - 우리가 잘 적용한 항목을 의미한다.
- Runtime Setting

  - 우리가 검사할 때 사용한 환경을 요약해서 보여주는 표

- Q. 깃헙에서 클론한 같은 프로젝트인데도 결과가 다르게 나오는 이유가 무엇일까여

- A. 강의의 검사 결과와 직접 검사한 결과가 상이한 이유에 대해 질문을 주셨는데요, 말씀해주신 것 처럼 네트워크 및 CPU (또는 GPU) 등의 환경에 따라 검사 결과가 달라집니다.
  왜냐하면, 크롬에 달려있는 Lighthouse 는 결국 로컬 PC에서 검사를 진행하기 때문에 PC 환경에 영향을 받을 수 밖에 없기 때문입니다.
  추가적인 예를 들면, 아래와 같은 상황에서는 같은 페이지여도 다른 결과가 나올 수 있습니다.
  - CPU의 작업량에 여유가 있는 상태 vs CPU가 바쁘게 돌고 있는 상태(여러 프로그램을  띄워둔 상태)
  - 미국에 있는 서버 홈페이지를 한국의 사용자가 검사할 때 vs 미국의 사용자가 검사할 때
  - 웹서버에 트래픽이 많은 상황에서 검사를 했을 때 vs 트래픽이 없는 상황에서 검사를 했을 때
  - 그래서 검사 결과를 절대적인 지표로 삼기 보다는 하나의 가이드로 생각하시는게 좋습니다.
    또한, 필요에 따라 한 번이 아닌 여러번 검사를 돌려보는 것도 좋은 방법입니다.
    참고하실 수 있는 링크를 하나 남겨드리겠습니다.
    구글에서 정리한 "Lighthouse 결과의 변동성"에 대한 글입니다.
    [https://developers.google.com/web/tools/lighthouse/variability](https://developers.google.com/web/tools/lighthouse/variability)

---

### 1.5 이미지 사이즈 최적화

- Properly size images

  - Serve images that are appropriately-sized to save cellular data and improve load time.
    - 이미지를 적절한 사이즈로 압축해서 셀룰러 데이터와 로드 타임을 향상시켜라
  - 이미지 사이즈와 최적화 했을 때 얼마만큼 줄일 수 있는지 확인할 수 있다.
  - 이미지 목록에 있는 것을 클릭하면 Element 탭으로 이동해서 이미지를 확인할 수 있다
  - 예를들어, Rendered size: 120 × 120 px, Intrinsic size: 1200 × 1200 px 인 상황을 가정해보자
  - 넓이로 따지면 우리가 실제 필요한 사이즈보다 100배보다 큰 이미지를 사용하고 있는 상황이다.
  - 이 때 이미지를 화면에 표시되는 이미지의 사이즈로 꼭 불러와야 하는 것은 아니다
  - 요즘 많이 쓰는 레티나 디스플레이는 같은 공간에 더 많은 픽셀을 그릴 수 있기 때문에 너비 기준으로 2배 정도 큰 이미지를 사용하는 것이 적절다.
  - 즉, 240 x 240 px이미지를 사용하는게 적절하다

- 이 이미지를 줄일 수 있는 방법 ?

  - 현재 이 이미지는 api를 통해서 받아오고 있다
  - 네트워크 탭의 articles의 response 에서 확인해보면, image라는 프로퍼티의 값으로 이미지를 받아오고 있다.
  - 이 이미지가 만약 자체 서버에 저장되어 있는 static 이미지라면 직접 이미지를 잘라서 올리면 되는데 api를 통해서 이미지를 받아오는 경우 어떻게 줄일 수 있을까 ?
  - 여기서 생각할 수 있는게 cloudinary나 imgix 같은 이미지 CDN을 사용하는 것이다

- CDN

  - Contents Delivery Network
  - 물리적 거리의 한계를 극복하기 위해 소비자(사용자)와 가까운 곳에 컨텐츠 서버를 두는 기술
  - 한국에 있는 사용자가 미국에 있는 서버에 이미지를 다운 받을 때 아무리 인터넷이 빨라졌다고 해도, 사용자와 서버 사이에는 엄청난 물리적 거리가 있기 때문에 다운로드 받는 시간이 상당히 많이 걸린다
  - 미국에 있는 서버를 미리 한국에 있는 서버에 복사해두고 사용자가 사진을 다운로드 할 때 한국에 있는 서버에서 바로 다운로드 해온다면 물리적 거리가 가까우니까 시간도 많이 줄어들 것이다

- Image CDN

  - 하지만 이 CDN과 Image CDN은 조금 다르다
  - 정확히는 Image Processing CDN이라고 하는데, Image CDN은 기본적인 CDN 의 개념과 이미지를 사용자에게 보내기 전에 특정형태로 가공해서
    예를 들면 사이즈를 줄이거나 이미지 포맷을 마꾸거나 하는 처리 과정을 거쳐서 사용자에게 이미지를 전달하게 된다.
  - 즉 서버에서 1200 px 사이즈의 이미지를 120px로 가공해서 사용자에게 전달해주는 것이다.
  - Image CDN의 예시

    ```shell
    http://cdn.image.com?src=[img src]&width=200&height=100

    # img src : 내가 전달하고자 하는 이미지 소스
    # &width=200&height=100 : 내가 원하는 결과 이미지 정보를 parameter로 전달
    # 원본 이미지가 가공된다.
    ```

- [브런치](https://brunch.co.kr/)의 한 이미지를 예로 들어 보자

```shell
https://img1.daumcdn.net/thumb/C240x0/?fname=http://t1.daumcdn.net/brunch/service/user/9tkU/image/MqdiMMegItU002H1o44CNzdXXSg.png

# daumcdn 이라는 cdn 도메인이 있고
# fname= 필드로 어떤 이미지의 주소가 붙게 된다

```

```shell
http://t1.daumcdn.net/brunch/service/user/9tkU/image/MqdiMMegItU002H1o44CNzdXXSg.png

# 원본 이미지로 들어가 보면 이전과 달리 이미지의 크기가 더 큰 것을 확인할 수 있다.

```

- 즉, 이미지 CDN을 거쳐서 사용자에게 작은 사이즈로 제공되는 것을 확인할 수 있다.
- 여기서는 이미지 CDN을 직접 구축했지만, 직접 구축하지 않고 이미지 CDN 솔루션을 사용할 수 있다.
- 대표적으로 imgix라는 서비스가 있다
- 이 서비스를 사용하면 CDN을 구축하지 않아도 된다.
- 이 강의에서는 이미지 CDN을 사용하지 않는다. 이 강의에서는 최적화 포인트를 찾는데 중점을 두기 때문

- `components/Article/index.js`에 보면 img 태그가 있는 것을 확인할 수 있다.

```js
<img
  src={props.image + getParametersForUnsplash({ width: 1200, height: 1200, quality: 80, format: 'jpg' })}
  alt="thumbnail"
/>
```

- 이미지를 넣는 것 뿐 아니라 width와 height를 정하고 있다.
- 이를 통해 앞서 Element 탭에서 확인한 이미지가 이 width와 height를 통해서 정해진 것을 알 수 있다
- 여기 있는 숫자 값을 변경하면 이미지의 사이즈도 줄어든 다는 것을 알 수 있다

```js
<img
  src={props.image + getParametersForUnsplash({ width: 240, height: 240, quality: 80, format: 'jpg' })}
  alt="thumbnail"
/>

// unsplash에 데이터를 요청하는데, unsplash가 이미지 CDN 역할을 한다고 볼 수 있다.
```

- 새로고침 후 다시 Element 탭에서 확인해보면 240 x 240 px로 이미지 크기가 줄어든 것을 확인할 수 있다.

- 다시 lighthoutse 탭에서 Generate report 클릭 한 후 결과를 확인해본다
- OPPORTUNITIES 항목을 확인해보면 Performance 점수는 거의 변한게 없는데, Properly size images 항목이 없어진 것을 확인할 수 있다
- 즉 이미지에 대한 성능저하가 사라진 것을 확인할 수 있다
- 이렇게 성능을 한단계 더 향상시킬 수 있다
-
